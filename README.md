# Valhalla Fjorge

Analyze your [Valhalla Bot](https://valhalla.bot) DLMM position performance with accurate Meteora PnL data.

Parses Discord DM logs from Valhalla Bot, resolves on-chain position addresses via Solana RPC, and fetches precise PnL from the Meteora DLMM API.

## Features

- **Accurate Meteora PnL** - per-position profit/loss from on-chain data (deposits, withdrawals, fees)
- **Multi-wallet support** - tracks multiple target wallets from a single log file
- **Rug detection** - identifies rug pulls and price-drop stop losses
- **Token metrics** - captures MC, Jup Score, token age at entry
- **Time-windowed stats** - 24h, 72h, 7d performance breakdowns
- **8 detailed charts** - daily PnL, win rate, entries, rugs, rolling averages (matplotlib)
- **HTML input** - paste Discord DMs directly from browser (auto-detects format)
- **Full datetime support** - embedded timestamps extracted from Discord HTML
- **Incremental merging** - build history over time without re-processing old logs
- **JSON export/import** - portable `.valhalla.json` for cross-session persistence
- **Modular architecture** - clean package structure with separate modules for parsing, RPC, API, charts
- **Coverage gap detection** - identifies missing time periods in position data
- **Insufficient balance tracking** - monitors wallet SOL balance issues

## Requirements

- Python 3.10+
- No external dependencies (stdlib only for core functionality)
- `matplotlib` (optional, for chart generation)

## Quick Start

### 1. Save your Discord DMs

Open your DM conversation with Valhalla Bot in Discord. Select the messages you want to analyze, then Ctrl+C.

The parser will automatically run the clipboard helper script (PowerShell) to extract HTML timestamps and save to `input/`.

To manually save clipboard:
```powershell
.\save_clipboard.ps1
```

This saves copied messages (with Solscan links and Discord timestamps preserved) to `input/YYYYMMDD_HHMMSS_discord.txt`.

### 2. Run the parser

```bash
# Process all files in input/ folder
python valhalla_parser_v2.py

# Process a specific file
python valhalla_parser_v2.py input/20260212_discord.txt

# Skip auto-clipboard save
python valhalla_parser_v2.py --no-clipboard
```

The parser will:
- Auto-run clipboard script (unless --no-clipboard)
- Auto-detect dates from filename or embedded timestamps
- Resolve position addresses via Solana RPC
- Fetch accurate PnL from Meteora API
- Generate CSV reports and charts in `output/`
- Move processed files to `archive/` with datetime range prefix

### 3. View results

Output files in `output/`:
- `positions.csv` - per-position details with PnL
- `summary.csv` - per-wallet aggregate statistics
- `insufficient_balance.csv` - wallet balance issues timeline
- `daily_pnl.png` - Daily PnL per wallet (SOL)
- `daily_pnl_pct.png` - Daily PnL % per wallet (ROI)
- `daily_entries.png` - Daily positions opened per wallet
- `daily_winrate.png` - Daily win rate per wallet (%)
- `daily_rugs.png` - Daily rug count (only wallets with recent rugs)
- `daily_pnl_rolling_3d.png` - 3-day rolling average PnL
- `daily_pnl_rolling_7d.png` - 7-day rolling average PnL
- `daily_insufficient_balance.png` - Daily insufficient balance events

## CLI Reference

```
python valhalla_parser_v2.py [input_files...] [options]

Positional:
  input_files              Log file(s) to parse (default: all files in input/)

Options:
  --output-dir DIR         Output directory (default: output/)
  --rpc-url URL            Solana RPC endpoint (default: public mainnet)
  --no-archive             Skip moving processed files to archive/
  --no-clipboard           Skip auto-running save_clipboard.ps1
  --skip-charts            Skip chart generation
  --cache-file FILE        Address cache JSON path
  --date YYYY-MM-DD        Override date for all input files
  --input-format FMT       Force input format: auto, text, html (default: auto)
  --export-json FILE       Export results as .valhalla.json
  --import-json FILE       Import previous .valhalla.json and merge
  --merge CSV [CSV ...]    Merge multiple positions.csv files
  --recover-insuf          Recover insufficient balance history from archive files
```

## Date Handling

Discord logs don't contain dates by default. Multiple ways to provide them (in priority order):

0. **Embedded timestamps** (auto-detected from HTML): `[YYYY-MM-DDTHH:MM]` format extracted from Discord HTML messages
1. **Filename prefix**: `20260212_discord.txt` (auto-generated by `save_clipboard.ps1`)
2. **In-file header**: Type `YYYYMMDD` on the first line of your log file
3. **User prompt**: The parser will ask for the date if not found

The parser detects midnight rollover automatically when the date is set.

## Incremental Workflow

Build up history day by day without re-processing old data:

```bash
# Day 1
python valhalla_parser_v2.py day1.txt --output-dir results/ \
  --export-json history.valhalla.json

# Day 2 (merge with previous)
python valhalla_parser_v2.py day2.txt --output-dir results/ \
  --import-json history.valhalla.json \
  --export-json history.valhalla.json

# Or merge existing CSV outputs
python valhalla_parser_v2.py --merge results/day1/positions.csv results/day2/positions.csv \
  --output-dir results/merged/
```

Deduplication by `position_id` ensures no double-counting. Previously open positions are automatically enriched when closed. Smart merge preserves Meteora PnL data when enriching positions.

## HTML Input

You can paste Discord DMs as HTML directly. The parser auto-detects the format and extracts message timestamps:

```bash
# Auto-detect (works for both .txt and .html)
python valhalla_parser_v2.py discord_feed.html --output-dir results/

# Force HTML mode
python valhalla_parser_v2.py clipboard.html --input-format html --output-dir results/
```

HTML processing extracts links, strips formatting, decodes entities, and captures message datetimes before parsing.

## Output Format

### positions.csv

| Column | Description |
|--------|-------------|
| datetime_open/close | ISO 8601 datetime (YYYY-MM-DDTHH:MM:SS) |
| target_wallet | Valhalla target wallet ID |
| token | Token name |
| position_type | Spot, BidAsk, or Curve |
| sol_deployed | SOL deposited into position |
| pnl_sol | Profit/loss in SOL |
| pnl_pct | Profit/loss percentage |
| close_reason | normal, failsafe, rug, still_open |
| mc_at_open | Market cap at position open |
| jup_score | Jupiter score (0-100) |
| token_age | Token age string (e.g., "4h ago") |
| token_age_days/hours | Normalized age values |
| pnl_source | "meteora" or "discord" |
| meteora_* | Detailed Meteora breakdown |

### summary.csv

Per-wallet statistics: positions, wins, losses, rugs, PnL, win rate, plus time-windowed breakdowns (24h, 72h, 7d).

### insufficient_balance.csv

Tracks events when wallets had insufficient SOL balance. Merges with existing data and deduplicates automatically.

## Charts

All charts are per-wallet line charts with consistent color coding. Wallets with 7+ day gaps are retired from charts.

- **daily_pnl.png** - Daily PnL per wallet in SOL, with Mean and Total lines
- **daily_pnl_pct.png** - Daily PnL % per wallet (ROI)
- **daily_entries.png** - Daily number of positions opened per wallet
- **daily_winrate.png** - Daily win rate per wallet (%)
- **daily_rugs.png** - Daily rug count (only shows wallets with recent rugs)
- **daily_pnl_rolling_3d.png** - 3-day rolling average PnL
- **daily_pnl_rolling_7d.png** - 7-day rolling average PnL
- **daily_insufficient_balance.png** - Daily insufficient balance events

## Coverage Gaps

The parser automatically detects time gaps in position data (periods with no position activity). Gaps larger than 3 hours are reported in the summary output.

Known gaps (e.g., overnight periods, intentional breaks) can be added to `gap_allowlist.txt` to suppress warnings:

```
# Format: MM-DD HH:MM -> MM-DD HH:MM
02-10 22:00 -> 02-11 08:00
```

## How PnL is Calculated

1. **Address resolution**: Extract Solscan TX signatures from logs, query Solana RPC to find the full DLMM position address
2. **Meteora API**: Fetch deposits, withdrawals, and claimed fees for each position
3. **Per-transaction SOL equivalent**: For each operation, derive SOL price from the SOL portion, convert token value to SOL at that price
4. **PnL = withdrawals + fees - deposits** (all in SOL equivalent)

Fallback to Discord balance-diff PnL when Meteora data is unavailable. Failed Meteora API calls trigger a retry prompt.

## Troubleshooting

**RPC rate limits**: Public Solana RPC limits to ~10 req/s. Use `--rpc-url` with a Helius or other RPC provider for faster resolution. The parser uses exponential backoff automatically.

**Meteora API timeouts**: Some positions may fail to fetch. Re-run the parser - resolved addresses are cached, so only failed Meteora calls are retried.

**Missing dates**: Charts and time-windowed stats require dates. Add `YYYYMMDD` at the top of your log files.

**No matplotlib**: Charts are skipped gracefully. Install with `pip install matplotlib` if you want them.

## Project Structure

```
valhalla_parser_v2.py       # Main entry point
valhalla/                   # Core package
  ├── models.py             # Data models (Position, PositionStats, etc.)
  ├── readers.py            # Input file readers (text, HTML)
  ├── event_parser.py       # Event parsing logic
  ├── solana_rpc.py         # Solana RPC client
  ├── meteora.py            # Meteora DLMM API client
  ├── matcher.py            # Position matching and enrichment
  ├── csv_writer.py         # CSV output generation
  ├── json_io.py            # JSON export/import
  ├── merge.py              # CSV merge logic
  └── charts.py             # Chart generation (matplotlib)
save_clipboard.ps1          # PowerShell clipboard helper - extracts timestamps
input/                      # Your Discord DM logs go here
output/                     # Generated CSV files and charts
archive/                    # Processed log files (auto-moved with datetime prefix)
gap_allowlist.txt           # Suppress known coverage gaps
sample_logs/                # Example log files
VERCEL_APP_SPEC.md          # Web app specification (future)
```

## License

MIT - see [LICENSE](LICENSE)

## Credits

- [Valhalla Bot](https://valhalla.bot) - the DLMM copy-trading bot
- [Meteora DLMM](https://dlmm.meteora.ag) - the DEX protocol
- [lpagent.io](https://lpagent.io) - used for PnL cross-reference validation
